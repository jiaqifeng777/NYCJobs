# Data Cleaning and Transformation
```{r}
library(forcats)
library(dplyr)
library(ggplot2)
library(devtools)
library(extracat)
```

```{r}
df_ori <- read.csv('data/NYC_Jobs.csv')
head(df_ori)
```
# Data Cleaning
```{r}
#select columns
df <- df_ori[,c('Agency', 'X..Of.Positions','Business.Title','Civil.Service.Title','Title.Classification','Level','Job.Category','Full.Time.Part.Time.indicator','Career.Level','Salary.Range.From','Salary.Range.To','Salary.Frequency','Division.Work.Unit','Minimum.Qual.Requirements','Preferred.Skills','Residency.Requirement','Work.Location')]
head(df)
```
```{r}
# Full time job
df <- df[df$Full.Time.Part.Time.indicator == 'F',]
# Entry Level Job
df <- df[df$Career.Level == 'Entry-Level',]
df <- df[ ,!(names(df) %in% c('Full.Time.Part.Time.indicator', 'Career.Level'))]
head(df)
```

# Data Transformation
```{r}
# find mean salary
df$mean.salary <- (df$Salary.Range.From + df$Salary.Range.To)/2

df <- df %>%
  mutate(res.requirement = case_when(
    grepl("not required", tolower(Residency.Requirement)) ~ 'not required',
    grepl("not currently required", tolower(Residency.Requirement)) ~ 'not required',
    grepl("no residency requirement", tolower(Residency.Requirement)) ~ 'not required',
    grepl("exempt from", tolower(Residency.Requirement)) ~ 'not required',
    grepl("generally required", tolower(Residency.Requirement)) ~ 'generally required',
    grepl("required within 90 days", tolower(Residency.Requirement)) ~ 'generally required',
    TRUE ~ 'required'
  ))
```
 
```{r}
#
#table(df$Minimum.Qual.Requirements)
#df <- df %>%
#  mutate(edu.require = case_when(
#    grepl('baccalaureate degree',Minimum.Qual.Requirements) ~ 'baccalaureate degree',
#    salary_type == 'week' ~ current_salary * 52,
#    TRUE ~ current_salary
#  ))
#table(df$Preferred.Skills)
```

# Missing Value
```{r}
devtools::install_github("heike/extracat")
#colSums(is.na(df))
df <- df %>% mutate_all(na_if,"")
df_ori <- df_ori %>% mutate_all(na_if,"")
colMeans(is.na(df))*100
#visualize original df
extracat::visna(df_ori)
#visualize transformed df
extracat::visna(df)

```

```{r}
#Preferred.Skills
skill_miss <- subset(df,is.na(Preferred.Skills))
ggplot(skill_miss, aes(x=Agency)) +
  geom_bar()+
  theme(axis.text.x=element_text(angle=45,hjust=1),
        axis.text=element_text(size=5)) +
  labs(title="Missing Prefered Skill by Agency")
```

```{r}
# Number of jobs by Agency
df_agency <- df %>%
  group_by(Agency) %>%
  summarise(Frequency = sum(X..Of.Positions))

ggplot(df_agency, aes(x = fct_reorder(Agency, Frequency,.desc = TRUE), y=Frequency))+
  geom_bar(stat='identity')  + 
  xlab("Agency")+
  ylab("Number of Jobs Posted") + 
  labs(title="Number of Jobs Posted by Agency")+
  theme(axis.text.x=element_text(angle=60,hjust=1),
        axis.text=element_text(size=5.5),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8))
```

```{r}
df_agency <- df %>%
  group_by(Agency) %>%
  summarise(Frequency = sum(X..Of.Positions))
df_agency <- df_agency %>%
  mutate(Agency =  
          case_when(Frequency <= 20 ~ "OTHER",
                    TRUE ~ Agency))
ggplot(df_agency, aes(x = fct_reorder(Agency, Frequency,.desc = TRUE), y=Frequency))+
  geom_bar(stat='identity')  + 
  xlab("Agency")+
  ylab("Number of Jobs Posted") + 
  labs(title="Number of Jobs Posted by Agency")+
  theme(axis.text.x=element_text(angle=60,hjust=1),
        axis.text=element_text(size=5.5),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8))
```
```{r}
s_agency <- df %>%
  filter(Salary.Frequency == 'Annual') %>%
  group_by(Agency) %>%
  summarise(avgSalary = mean(mean.salary))
s_agency
ggplot(s_agency, aes(x = fct_reorder(Agency, avgSalary,.desc = TRUE), y=avgSalary))+
  geom_bar(stat='identity')  +
  xlab("Agency")+
  ylab("Average Salary") + 
  labs(title="Average Salary of Jobs Posted by Agency")+
  theme(axis.text.x=element_text(angle=60,hjust=1),
        axis.text=element_text(size=5.5),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8))
```
```{r}
table(df$Job.Category)
```
```{r}
jobcat <- function(cat) {
  result <- c()
  if (length(cat)==0){
    return(result)
  }
  if (grepl(',',cat)){
    result <- strsplit(cat, ",")[[1]]
    for (i in 1:length(result)){
      if (substr(result[i],0,1) == ' '){
        result[i] = sub(" ","",result[i])
      }
      if (substr(result[i],0,2) == '& '){
        result[i] = sub("& ","",result[i])
      }
    }
  } else {
    result <- c()
    result[0] <- cat
  }
  return(result)
}
df$skilst <-lapply(df$Job.Category, jobcat)
```

